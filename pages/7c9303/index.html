<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>shadowsocks原理——模块划分 | Allen&#39;s blog</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="web前端技术博客,专注web前端学习与总结。JavaScript,js,ES6,TypeScript,vue,React,python,css3,html5,Node,git,github等技术文章。">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.b4a058fd.css" as="style"><link rel="preload" href="/assets/js/app.2fe7a956.js" as="script"><link rel="preload" href="/assets/js/2.c04d3963.js" as="script"><link rel="preload" href="/assets/js/3.15b8c2b2.js" as="script"><link rel="preload" href="/assets/js/85.82908103.js" as="script"><link rel="prefetch" href="/assets/js/10.6b6c7de4.js"><link rel="prefetch" href="/assets/js/100.e026d48d.js"><link rel="prefetch" href="/assets/js/101.5c3c63bd.js"><link rel="prefetch" href="/assets/js/102.57ef2280.js"><link rel="prefetch" href="/assets/js/103.dfe3e1fa.js"><link rel="prefetch" href="/assets/js/104.a053a28b.js"><link rel="prefetch" href="/assets/js/105.bac46026.js"><link rel="prefetch" href="/assets/js/106.06cc4052.js"><link rel="prefetch" href="/assets/js/107.cc95972c.js"><link rel="prefetch" href="/assets/js/11.e7832c4f.js"><link rel="prefetch" href="/assets/js/12.446aef51.js"><link rel="prefetch" href="/assets/js/13.87134001.js"><link rel="prefetch" href="/assets/js/14.186ae4df.js"><link rel="prefetch" href="/assets/js/15.1e8989c4.js"><link rel="prefetch" href="/assets/js/16.857cca85.js"><link rel="prefetch" href="/assets/js/17.320795d3.js"><link rel="prefetch" href="/assets/js/18.8892cc29.js"><link rel="prefetch" href="/assets/js/19.9b13ecad.js"><link rel="prefetch" href="/assets/js/20.aadf798b.js"><link rel="prefetch" href="/assets/js/21.4836f25d.js"><link rel="prefetch" href="/assets/js/22.e8a5e600.js"><link rel="prefetch" href="/assets/js/23.03427f0c.js"><link rel="prefetch" href="/assets/js/24.4ad88045.js"><link rel="prefetch" href="/assets/js/25.4a610cfc.js"><link rel="prefetch" href="/assets/js/26.20e26bb9.js"><link rel="prefetch" href="/assets/js/27.f8bc6817.js"><link rel="prefetch" href="/assets/js/28.c43c44f8.js"><link rel="prefetch" href="/assets/js/29.8503a039.js"><link rel="prefetch" href="/assets/js/30.ffb0d19f.js"><link rel="prefetch" href="/assets/js/31.411a2966.js"><link rel="prefetch" href="/assets/js/32.d74d0272.js"><link rel="prefetch" href="/assets/js/33.ef4618c7.js"><link rel="prefetch" href="/assets/js/34.97c8f918.js"><link rel="prefetch" href="/assets/js/35.89543cd6.js"><link rel="prefetch" href="/assets/js/36.eaae6615.js"><link rel="prefetch" href="/assets/js/37.844ab029.js"><link rel="prefetch" href="/assets/js/38.d064f7d8.js"><link rel="prefetch" href="/assets/js/39.0b2c5e12.js"><link rel="prefetch" href="/assets/js/4.a761e263.js"><link rel="prefetch" href="/assets/js/40.73f16de3.js"><link rel="prefetch" href="/assets/js/41.2f545953.js"><link rel="prefetch" href="/assets/js/42.5a7d191c.js"><link rel="prefetch" href="/assets/js/43.c841a617.js"><link rel="prefetch" href="/assets/js/44.20061e11.js"><link rel="prefetch" href="/assets/js/45.3e93867a.js"><link rel="prefetch" href="/assets/js/46.35dc311b.js"><link rel="prefetch" href="/assets/js/47.cd728130.js"><link rel="prefetch" href="/assets/js/48.0880606e.js"><link rel="prefetch" href="/assets/js/49.bdd51091.js"><link rel="prefetch" href="/assets/js/5.693f13a3.js"><link rel="prefetch" href="/assets/js/50.2e11e0c6.js"><link rel="prefetch" href="/assets/js/51.e7c0360a.js"><link rel="prefetch" href="/assets/js/52.ef6e1a41.js"><link rel="prefetch" href="/assets/js/53.f231f3ae.js"><link rel="prefetch" href="/assets/js/54.ebeb0f61.js"><link rel="prefetch" href="/assets/js/55.5a7f3e0c.js"><link rel="prefetch" href="/assets/js/56.3f3a133a.js"><link rel="prefetch" href="/assets/js/57.52adc10c.js"><link rel="prefetch" href="/assets/js/58.0f747cc5.js"><link rel="prefetch" href="/assets/js/59.575f851f.js"><link rel="prefetch" href="/assets/js/6.e60e28b8.js"><link rel="prefetch" href="/assets/js/60.22e7cd8e.js"><link rel="prefetch" href="/assets/js/61.87d55efa.js"><link rel="prefetch" href="/assets/js/62.2e2ba49e.js"><link rel="prefetch" href="/assets/js/63.4b0ae4e0.js"><link rel="prefetch" href="/assets/js/64.a3c34cb6.js"><link rel="prefetch" href="/assets/js/65.9e258b72.js"><link rel="prefetch" href="/assets/js/66.94cd81e4.js"><link rel="prefetch" href="/assets/js/67.f55858a6.js"><link rel="prefetch" href="/assets/js/68.0670fdec.js"><link rel="prefetch" href="/assets/js/69.ab973370.js"><link rel="prefetch" href="/assets/js/7.e0112e7f.js"><link rel="prefetch" href="/assets/js/70.593aca3b.js"><link rel="prefetch" href="/assets/js/71.82440ae4.js"><link rel="prefetch" href="/assets/js/72.af47ef77.js"><link rel="prefetch" href="/assets/js/73.7cb0e5a4.js"><link rel="prefetch" href="/assets/js/74.22b0b623.js"><link rel="prefetch" href="/assets/js/75.cae664ee.js"><link rel="prefetch" href="/assets/js/76.58aee0b9.js"><link rel="prefetch" href="/assets/js/77.1e2f7c61.js"><link rel="prefetch" href="/assets/js/78.35bcb8c2.js"><link rel="prefetch" href="/assets/js/79.b96e72e6.js"><link rel="prefetch" href="/assets/js/8.87730027.js"><link rel="prefetch" href="/assets/js/80.76141f33.js"><link rel="prefetch" href="/assets/js/81.e234e92e.js"><link rel="prefetch" href="/assets/js/82.405f6b37.js"><link rel="prefetch" href="/assets/js/83.591a1b71.js"><link rel="prefetch" href="/assets/js/84.20c87682.js"><link rel="prefetch" href="/assets/js/86.3edef492.js"><link rel="prefetch" href="/assets/js/87.63eed3a3.js"><link rel="prefetch" href="/assets/js/88.083d2e8f.js"><link rel="prefetch" href="/assets/js/89.3fd6b173.js"><link rel="prefetch" href="/assets/js/9.c275b099.js"><link rel="prefetch" href="/assets/js/90.ee4493e3.js"><link rel="prefetch" href="/assets/js/91.529fde4a.js"><link rel="prefetch" href="/assets/js/92.76267382.js"><link rel="prefetch" href="/assets/js/93.1ae3948e.js"><link rel="prefetch" href="/assets/js/94.a3b9f780.js"><link rel="prefetch" href="/assets/js/95.94cf7881.js"><link rel="prefetch" href="/assets/js/96.baefc5de.js"><link rel="prefetch" href="/assets/js/97.584d5cd4.js"><link rel="prefetch" href="/assets/js/98.caaac360.js"><link rel="prefetch" href="/assets/js/99.4b0985f8.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b4a058fd.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="Allen's blog" class="logo"> <span class="site-name can-hide">Allen's blog</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/589315/" class="nav-link">面经</a></div><div class="nav-item"><a href="https://www.programmercarl.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://fastly.jsdelivr.net/gh/xugaoyi/image_store/blog/20200103123203.jpg"> <div class="blogger-info"><h3>Allen</h3> <span>前端CV工程师</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/pages/589315/" class="nav-link">面经</a></div><div class="nav-item"><a href="https://www.programmercarl.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  算法
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="/categories/" class="nav-link">分类</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>shadowsocks代理架构</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/7c9303/" aria-current="page" class="active sidebar-link">shadowsocks原理——模块划分</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/7c9303/#reactor-模型" class="sidebar-link">reactor 模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7c9303/#_1-io-进化史" class="sidebar-link">1. IO 进化史</a></li><li class="sidebar-sub-header level4"><a href="/pages/7c9303/#四种常见的-io-模型" class="sidebar-link">四种常见的 IO 模型</a></li><li class="sidebar-sub-header level4"><a href="/pages/7c9303/#事件驱动" class="sidebar-link">事件驱动</a></li><li class="sidebar-sub-header level4"><a href="/pages/7c9303/#reactor-模型-2" class="sidebar-link">Reactor 模型</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/7c9303/#reactor-三种方式" class="sidebar-link">Reactor 三种方式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/7c9303/#单线程模型" class="sidebar-link">单线程模型</a></li><li class="sidebar-sub-header level4"><a href="/pages/7c9303/#多线程模型" class="sidebar-link">多线程模型</a></li><li class="sidebar-sub-header level4"><a href="/pages/7c9303/#主从多线程模型" class="sidebar-link">主从多线程模型</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>博客搭建</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Git</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/categories/?category=%E5%85%B6%E4%BB%96%E6%8A%80%E6%9C%AF" title="分类" data-v-06970110>其他技术</a></li><li data-v-06970110><a href="/categories/?category=shadowsocks%E4%BB%A3%E7%90%86%E6%9E%B6%E6%9E%84" title="分类" data-v-06970110>shadowsocks代理架构</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/allenice1565" target="_blank" title="作者" class="beLink" data-v-06970110>Allen</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2023-06-04</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">shadowsocks原理——模块划分<!----></h1>  <div class="theme-vdoing-content content__default"><p>没有基础，直接阅读源码，就像是苹果砸到自己头上，然后自己努力推算出万有引力公式。难度太大了，就算能达到目标，也会相当艰难，效率很低。</p> <p>因此，学习一个工具，需要我们从顶层设计，然后逐步深入剖析，这样，在学习的时候会更容易构建知识网络，既不枯燥，也可以融会贯通。</p> <p>shadowsocks 项目代码量少，2000 多行。大神们觉得逻辑简单，然而我从 15 年接触，到 23 年，都没能完整阅读 shadowsocks 项目，经常是遇到什么问题，就选择放弃，因为直接生啃源代码，没有一些理论基础，会不明白为什么进行一些操作，一些模型应用广泛，我们往往是直接使用，新手直接看源代码，可能会因为各个模型或者设计模式不太熟悉，就看不懂了。我就是这样。这一次，我记录一下我的探索过程。</p> <p>首先，ss 的通信流程是在本地建立本地服务器(sslocal)，本地所有网络走本地服务器(sslocal)进行代理，本地服务器(sslocal)加密后转发到远程服务器(ssserver)，远程服务器(ssserver)验证身份和解密后，转发到目标服务器。目标服务器返回的数据再通过远程服务器(ssserver)加密后传回本地服务器(sslocal)，本地服务器(sslocal)解密后，再转发回本地应用程序。</p> <p>sslocal 和 ssserver 都是采用的 reactor 模型。这里需要积累一下 reactor 模型基础知识，这是架构 sslocal 和 ssserver 的模型，理解了这个模型，才能理解 sslocal 和 ssserver</p> <h2 id="reactor-模型"><a href="#reactor-模型" class="header-anchor">#</a> reactor 模型</h2> <p>网络框架的设计离不开 I/O 线程模型，线程模型的优劣直接决定了系统的吞吐量、可扩展性、安全性等。目前主流的网络框架几乎都采用了 I/O 多路复用的方案。Reactor 模式作为其中的<strong>事件分发器</strong>，负责将<u>读写事件</u><strong>分发</strong>给对应的读写<u>事件处理者</u>。</p> <p>大名鼎鼎的 Java 并发包作者 Doug Lea，在 Scalable I/O in Java 一文中阐述了服务端开发中 I/O 模型的演进过程。Netty 中三种 Reactor 线程模型也来源于这篇经典文章.</p> <h3 id="_1-io-进化史"><a href="#_1-io-进化史" class="header-anchor">#</a> 1. IO 进化史</h3> <p>一个网络请求，在服务端经历的阶段：</p> <p><img src="https://raw.githubusercontent.com/allenice1565/image-host/main/20230604225744.png" alt=""></p> <p>网络请求先后经历服务器网卡、内核、连接建立、数据读取、业务处理、数据写回等一系列过程。</p> <p>其中，连接建立(accept)、数据读取(read)、数据写回(write)等操作都需要操作系统内核提供的系统调用，最终由内核与网卡进行数据交互，这些 IO 调用消耗一般是比较高的，比如 IO 等待、数据传输等。</p> <p>最初的处理方式是，每个连接都用独立的一个线程来处理这一系列的操作，即 建立连接、数据读写、业务逻辑处理；这样一来最大的弊端在于，N 个连接就需要 N 个线程资源，消耗巨大。</p> <p>所以，在网络模型演化过程中，不断的对这几个阶段进行拆分，比如，将建立连接、数据读写、业务逻辑处理等关键阶段分开处理；这样一来，每个阶段都可以考虑使用单线程或者线程池来处理，极大的节约线程资源；同时，又能获得超高性能。</p> <p>在深入了解之前，需要了解一下<strong>四种常见的 IO 模型</strong>以及<strong>内核提供的 select/poll/epoll 模型</strong></p> <h4 id="四种常见的-io-模型"><a href="#四种常见的-io-模型" class="header-anchor">#</a> 四种常见的 IO 模型</h4> <p>IO 模型需要解决的问题</p> <blockquote><p>数据读取的实际场景：首先是在用户态发起调用操作，通过系统函数 read()间接的调用系统内核，从网卡读取数据，先将数据读取到内核缓冲区，再由内核缓冲区拷贝到用户态内存缓冲区</p> <p>在这个过程中，涉及到 cpu 的操作、内存操作、外部物理设备操作；由于三者数据处理速度的巨大差异性，用户读取数据时，采用 用户线程阻塞等待？非阻塞轮询查询并读取数据？还是由内核回调通知？这些便是 I/O 模型要解决的问题</p></blockquote> <p><strong>I/O 模型的区别</strong></p> <p>当用户线程发起 I/O 操作后，网络数据读取操作会经历两个步骤：</p> <ol><li>用户线程等待内核将数据从网卡拷贝到内核空间。</li> <li>内核将数据从内核空间拷贝到用户空间</li></ol> <p>各种 I/O 模型的区别就是：它们实现这两个步骤的方式是不一样的</p> <p><strong>4 种主要的 IO 模型</strong></p> <ol><li>同步阻塞</li></ol> <p>用户线程发起 read 调用后就阻塞了，让出 CPU。内核等待网卡数据到来，把数据从网卡拷贝到内核空间，接着把数据拷贝到用户空间，再把用户线程叫醒</p> <p><img src="https://raw.githubusercontent.com/allenice1565/image-host/main/20230604235611.png" alt=""></p> <ol start="2"><li>同步非阻塞</li></ol> <p>用户线程不断的发起 read 调用，数据没到内核空间时，每次都返回失败，直到数据到了内核空间，这一次 read 调用后，在等待数据从内核空间拷贝到用户空间这段时间里，线程还是阻塞的，等数据到了用户空间再把线程叫醒</p> <p><img src="https://raw.githubusercontent.com/allenice1565/image-host/main/20230605232642.png" alt=""></p> <ol start="3"><li>IO 多路复用</li></ol> <p>用户线程的读取操作分成两步了，线程先发起 select 调用，目的是问内核数据准备好了吗？等内核把数据准备好了，用户线程再发起 read 调用。在等待数据从内核空间拷贝到用户空间这段时间里，线程还是阻塞的。那为什么叫 I/O 多路复用呢？因为一个专用线程轮询发起 select 调用可以向内核查多个数据通道（Channel）的状态，所以叫多路复用</p> <p><img src="https://raw.githubusercontent.com/allenice1565/image-host/main/20230605232712.png" alt=""></p> <ol start="4"><li>异步 IO</li></ol> <p>用户线程发起 read 调用的同时注册一个回调函数，read 立即返回，等内核将数据准备好后，再调用指定的回调函数完成处理。在这个过程中，用户线程一直没有阻塞</p> <p><img src="https://raw.githubusercontent.com/allenice1565/image-host/main/20230605232752.png" alt=""></p> <p><strong>4 种 IO 模型的总结</strong></p> <p>1、同步非阻塞与 I/O 多路复用区别</p> <p>相同点：都通过<strong>轮询</strong>的方式尝试读取数据；不同的是 一个是由<strong>用户线程自己</strong>不断轮询，另一个是通过<strong>专用线程</strong>去轮询处理(专用线程数量可控)
同步非阻塞：用户线程不断轮询直到读取数据为止；这个过程中每个用户线程都是轮询读取，如果用户线程过多，耗费资源
I/O 多路复用：一般通过一个专用线程去轮询检查数据是否就绪，由于一个专用线程可以处理多个连接(channel 通道)，也就称为 I/O 多路复用；Java NIO 便是 I/O 多路复用的一个实现</p> <p>2、阻塞与非阻塞：指应用程序在发起 I/O 操作时，是立即返回还是等待</p> <p>3、同步与异步：指应用程序在与内核通信时，数据从内核空间到应用空间的拷贝，是由内核主动发起还是由应用程序来触发；内核主动发起则是异步，反之为同步</p> <p>一个线程就可以监听所有网络连接的 IO 事件是否就绪的模式，就是 IO 多路复用</p> <p>Reactor 模型就是基于 IO 多路复用构建的</p> <blockquote><p>非阻塞 NIO 搭配 IO 多路复用机制是高并发的钥匙
libhv 下的 event 模块正是封装了多种平台的 IO 多路复用机制，提供了统一的事件接口，是 libhv 的核心模块。</p></blockquote> <h4 id="事件驱动"><a href="#事件驱动" class="header-anchor">#</a> 事件驱动</h4> <p>IO 模型是 Reactor 模型的一半，另一半则是事件驱动。事件驱动指的是当 IO 事件准备就绪时，以事件的形式通知相关线程进行数据读写，进而业务线程可以直接处理这些数据，这一过程的后续操作方，都是被动接收通知，看起来有点像回调操作。</p> <p>这种模式下，IO 读写线程、业务线程工作时，必有数据可操作执行，不会在 IO 等待上浪费资源，这便是事件驱动的核心思想。</p> <h4 id="reactor-模型-2"><a href="#reactor-模型-2" class="header-anchor">#</a> Reactor 模型</h4> <p><img src="https://raw.githubusercontent.com/allenice1565/image-host/main/20230605234224.png" alt="">
Reactor 模型的核心是事件驱动，Reactor 模型种的反应器角色（Reactor 线程）类似于事件转发器，承接事件建立、IO 处理、事件分发的任务。</p> <p>Reactor 模式由 <code>Reactor 线程</code>、<code>Handlers 处理器</code>两大角色组成，两大角色的职责分别如下：</p> <ul><li>Reactor 线程的职责：主要负责连接建立、监听 IO 事件、IO 事件读写以及将事件分发到 Handlers 处理器。</li> <li>Handlers 处理器（业务处理）的职责：非阻塞的执行业务处理逻辑。</li></ul> <h2 id="reactor-三种方式"><a href="#reactor-三种方式" class="header-anchor">#</a> Reactor 三种方式</h2> <p>Reactor 模型在不同阶段都有相关的优化策略，常见的有以下三种方式呈现：</p> <ul><li>单线程模型</li> <li>多线程模型</li> <li>主从多线程模型</li></ul> <p>多线程 Reactor 的演进分为两个方面：</p> <ul><li>升级 Handler。既要使用多线程，又要尽可能高效率，则可以考虑使用线程池。</li> <li>升级 Reactor。可以考虑引入多个 Selector（选择器），提升选择大量通道的能力。</li></ul> <h3 id="单线程模型"><a href="#单线程模型" class="header-anchor">#</a> 单线程模型</h3> <p><img src="https://raw.githubusercontent.com/allenice1565/image-host/main/20230606001143.png" alt=""></p> <p>上图描述了 Reactor 的单线程模型结构，在 Reactor 单线程模型中，所有 I/O 操作（包括连接建立、数据读写、事件分发等）、业务处理，都是由一个线程完成的。单线程模型逻辑简单，缺陷也十分明显：</p> <ul><li><p>一个线程支持处理的连接数非常有限，CPU 很容易打满，性能方面有明显瓶颈；</p></li> <li><p>当多个事件被同时触发时，只要有一个事件没有处理完，其他后面的事件就无法执行，这就会造成消息积压及请求超时；</p></li> <li><p>线程在处理 I/O 事件时，Select 无法同时处理连接建立、事件分发等操作；</p></li> <li><p>如果 I/O 线程一直处于满负荷状态，很可能造成服务端节点不可用。</p></li></ul> <p>在单线程 Reactor 模式中，<u>Reactor 和 Handler 都在同一条线程中执行</u>。这样，带来了一个问题：当其中某个 Handler 阻塞时，会导致其他所有的 Handler 都得不到执行。</p> <p>在这种场景下，被阻塞的 Handler 不仅仅负责输入和输出处理的传输处理器，还包括负责新连接监听的 Acceptor 处理器，可能导致服务器无响应。这是一个非常严重的缺陷，导致单线程反应器模型在生产场景中<strong>使用得比较少</strong>。</p> <h4 id="多线程模型"><a href="#多线程模型" class="header-anchor">#</a> 多线程模型</h4> <p><img src="https://raw.githubusercontent.com/allenice1565/image-host/main/20230606001356.png" alt=""></p> <p>由于单线程模型有性能方面的瓶颈，多线程模型作为解决方案就应运而生了。</p> <p>Reactor 多线程模型将业务逻辑交给多个线程进行处理。除此之外，多线程模型其他的操作与单线程模型是类似的，比如连接建立、IO 事件读写以及事件分发等都是由一个线程来完成。</p> <p>当客户端有数据发送至服务端时，Select 会监听到可读事件，数据读取完毕后提交到业务线程池中并发处理。</p> <p>一般的请求中，耗时最长的一般是业务处理，所以用一个线程池（worker 线程池）来处理业务操作，在性能上的提升也是非常可观的。</p> <p>当然，这种模型也有明显缺点，连接建立、IO 事件读取以及事件分发完全有单线程处理；比如当某个连接通过系统调用正在读取数据，此时相对于其他事件来说，完全是阻塞状态，新连接无法处理、其他连接的 IO 查询/IO 读写以及事件分发都无法完成。</p> <p>对于像 Nginx、Netty 这种对高性能、高并发要求极高的网络框架，这种模式便显得有些吃力了。因为，无法及时处理新连接、就绪的 IO 事件以及事件转发等。</p> <p>接下来，我们看看主从多线程模型是如何解决这个问题的。</p> <h4 id="主从多线程模型"><a href="#主从多线程模型" class="header-anchor">#</a> 主从多线程模型</h4> <p><img src="https://raw.githubusercontent.com/allenice1565/image-host/main/20230606004601.png" alt=""></p> <p>在多线程模型中，我们提到，其主要缺陷在于同一时间无法处理<strong>大量新连接、IO 就绪事件</strong>。因此，将主从模式应用到这一块，就可以解决这个问题。</p> <p>主从 Reactor 模式中，分为了主 Reactor 和 从 Reactor，分别处理 <code>新建立的连接</code>、<code>IO读写事件/事件分发</code>。</p> <p>一来，主 Reactor 可以解决同一时间大量新连接，将其注册到从 Reactor 上进行 IO 事件监听处理</p> <p>二来，IO 事件监听相对新连接处理更加耗时，此处我们可以考虑使用线程池来处理。这样能充分利用多核 CPU 的特性，能使更多就绪的 IO 事件及时处理。</p> <p>简言之，主从多线程模型由多个 Reactor 线程组成，每个 Reactor 线程都有独立的 Selector 对象。MainReactor 仅负责处理客户端连接的 Accept 事件，连接建立成功后将新创建的连接对象注册至 SubReactor。再由 SubReactor 分配线程池中的 I/O 线程与其连接绑定，它将负责连接生命周期内所有的 I/O 事件。
在海量客户端并发请求的场景下，主从多线程模式甚至可以适当增加 SubReactor 线程的数量，从而利用多核能力提升系统的吞吐量。</p> <p>参考文章：
<a href="https://blog.csdn.net/ldw201510803006/article/details/119767467?spm=1001.2014.3001.5501" target="_blank" rel="noopener noreferrer">一文搞懂，4 种主要的 I/O 模型（高并发 IO 的底层原理）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/7092436770519777311" target="_blank" rel="noopener noreferrer">高性能网络编程之 Reactor 网络模型（彻底搞懂）<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/12/16, 09:22:46</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><!----> <a href="/pages/c574a1/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">使用vuepress搭建静态博客并免费部署到Github</div></a></div> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/pages/c574a1/">使用vuepress搭建静态博客并免费部署到Github</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/f6535a/"><div>
            rollup使用配置文件rollup.config.ts打包
            <!----></div></a> <span class="date">12-08</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/63c616/"><div>
            package.json导出类型
            <!----></div></a> <span class="date">12-08</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/f33340/"><div>
            关键问题方案
            <!----></div></a> <span class="date">11-17</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2023-2023
    <span>Allen | <a href="https://github.com/allenice1565" target="_blank">Github</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2fe7a956.js" defer></script><script src="/assets/js/2.c04d3963.js" defer></script><script src="/assets/js/3.15b8c2b2.js" defer></script><script src="/assets/js/85.82908103.js" defer></script>
  </body>
</html>
